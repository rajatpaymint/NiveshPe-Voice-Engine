<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NiveshPe - Voice Investment Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .step {
            display: none;
            animation: fadeIn 0.5s;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .risk-profile {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .risk-profile h2 {
            margin-bottom: 10px;
        }

        .voice-recorder {
            text-align: center;
            padding: 30px;
            border: 3px dashed #667eea;
            border-radius: 12px;
            margin: 20px 0;
        }

        .record-button {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            font-size: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            cursor: pointer;
            transition: all 0.3s;
        }

        .record-button:hover {
            transform: scale(1.1);
        }

        .record-button.recording {
            animation: pulse 1.5s infinite;
            background: #f5576c;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .transcription {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-style: italic;
            color: #555;
        }

        .allocation-card {
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .fund-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .fund-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .fund-name {
            font-weight: 600;
            color: #667eea;
        }

        .fund-percentage {
            font-size: 24px;
            font-weight: bold;
            color: #764ba2;
        }

        .fund-details {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #666;
        }

        .blended-return {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
            font-size: 20px;
        }

        .modification-count {
            text-align: center;
            color: #666;
            margin-top: 20px;
            font-size: 14px;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .button-group button {
            flex: 1;
        }

        .secondary-button {
            background: #6c757d;
        }

        .secondary-button:hover {
            background: #5a6268;
        }

        .audio-player {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .audio-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .audio-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }

        .audio-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        }

        .audio-button.muted {
            background: #f5576c;
            color: white;
        }

        .audio-status {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
            font-style: italic;
        }

        .conversation-container {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 12px;
        }

        .bot-message-section {
            margin-bottom: 20px;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bot-message {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .bot-avatar {
            font-size: 32px;
            flex-shrink: 0;
        }

        .bot-message-content {
            flex: 1;
        }

        .bot-message-content p {
            margin: 0;
            line-height: 1.6;
            color: #333;
        }

        .user-message {
            display: flex;
            gap: 15px;
            align-items: flex-start;
            flex-direction: row-reverse;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .user-avatar {
            font-size: 32px;
            flex-shrink: 0;
        }

        .user-message-content {
            flex: 1;
            text-align: right;
        }

        .user-message-content p {
            margin: 0;
            line-height: 1.6;
            color: #333;
        }

        .message-timestamp {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ NiveshPe</h1>
        <p class="subtitle">Voice-Powered Investment Recommendation Engine</p>

        <!-- Step 1: User Onboarding -->
        <div id="step1" class="step active">
            <h2 style="margin-bottom: 20px;">üìã User Profile</h2>
            <div class="form-group">
                <label for="salary">Monthly Salary (INR)</label>
                <input type="number" id="salary" placeholder="e.g., 50000" required>
            </div>
            <div class="form-group">
                <label for="occupation">Occupation</label>
                <select id="occupation" required>
                    <option value="">Select Occupation</option>
                    <option value="Business">Business</option>
                    <option value="Private Job">Private Job</option>
                    <option value="Freelancer">Freelancer</option>
                    <option value="Professional">Professional</option>
                    <option value="Student">Student</option>
                    <option value="Govt Service">Govt Service</option>
                    <option value="Public Sector Service">Public Sector Service</option>
                    <option value="Housewife">Housewife</option>
                    <option value="Retired">Retired</option>
                    <option value="Shopkeeper">Shopkeeper</option>
                    <option value="Agriculture">Agriculture</option>
                    <option value="Others">Others</option>
                </select>
            </div>
            <div class="form-group">
                <label for="dependents">Number of Dependents</label>
                <input type="number" id="dependents" placeholder="e.g., 2" min="0" required>
            </div>
            <div class="form-group">
                <label for="age">Age</label>
                <input type="number" id="age" placeholder="e.g., 30" min="18" max="100" required>
            </div>
            <div class="form-group">
                <label for="preferredLanguage">Preferred Language</label>
                <select id="preferredLanguage" required>
                    <option value="">Select Language</option>
                    <option value="english">English</option>
                    <option value="hindi">Hindi (‡§π‡§ø‡§Ç‡§¶‡•Ä)</option>
                </select>
            </div>
            <button onclick="calculateRisk()">Calculate Risk Profile</button>
        </div>

        <!-- Step 2: Conversational Investment Planning -->
        <div id="step2" class="step">
            <div id="riskProfile" class="risk-profile"></div>

            <h2 style="margin-bottom: 20px;">üí¨ Let's Plan Your Investment</h2>

            <!-- Conversation History -->
            <div id="conversationContainer" class="conversation-container">
                <!-- Bot and user messages will appear here -->
            </div>

            <!-- Bot Message Display (for current question) -->
            <div id="botMessageSection" class="bot-message-section" style="display: none;">
                <div class="bot-message">
                    <div class="bot-avatar">ü§ñ</div>
                    <div class="bot-message-content">
                        <p id="botMessageText"></p>
                        <audio id="botAudioPlayer" style="display: none;"></audio>
                    </div>
                </div>
            </div>

            <!-- Voice Input Section -->
            <div class="voice-recorder">
                <p id="recordInstructions">Click the microphone to respond (stops after 5 seconds of silence)</p>
                <div id="recordButton" class="record-button" onclick="toggleRecording()">üé§</div>
                <p id="recordingStatus">Waiting for bot...</p>
                <div id="transcription" class="transcription" style="display: none;"></div>
            </div>
        </div>

        <!-- Step 3: Allocation Display -->
        <div id="step3" class="step">
            <h2 style="margin-bottom: 20px;">üìä Your Investment Allocation</h2>

            <!-- Audio Player -->
            <div id="audioPlayerSection" class="audio-player" style="display: none;">
                <h3 style="margin-bottom: 10px;">üîä Voice Explanation</h3>
                <p id="audioStatus" class="audio-status">Preparing audio...</p>
                <audio id="audioPlayer" style="display: none;"></audio>
                <div class="audio-controls">
                    <button class="audio-button" onclick="toggleMute()" id="muteButton" title="Mute/Unmute">
                        üîä
                    </button>
                    <button class="audio-button" onclick="replayAudio()" title="Replay Explanation">
                        üîÑ
                    </button>
                </div>
            </div>

            <div id="allocationDisplay"></div>
            <div class="modification-count" id="modificationCount">Modifications remaining: 2</div>
            <div class="button-group">
                <button class="secondary-button" onclick="finalizeAllocation()">‚úÖ Finalize</button>
                <button onclick="modifyAllocation()">üîÑ Modify</button>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Processing...</p>
        </div>

        <!-- Error Display -->
        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script>
        let userProfile = null;
        let currentAllocation = null;
        let modificationCount = 0;
        let mediaRecorder = null;
        let audioChunks = [];
        let transcribedText = '';
        let audioContext = null;
        let analyser = null;
        let silenceTimer = null;
        let silenceStart = null;
        let isDetectingSilence = false;
        let audioPlayer = null;
        let isMuted = false;
        let currentAudioSrc = null;
        let detectedLanguage = 'english';

        // Conversation state
        let conversationHistory = [];
        let conversationStage = 'not_started';
        let waitingForUser = false;
        let botAudioPlayer = null;
        let userPreferredLanguage = 'english'; // Default language

        function showStep(stepNumber) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.getElementById('step' + stepNumber).classList.add('active');
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        async function calculateRisk() {
            const salary = document.getElementById('salary').value;
            const occupation = document.getElementById('occupation').value;
            const dependents = document.getElementById('dependents').value;
            const age = document.getElementById('age').value;
            const preferredLanguage = document.getElementById('preferredLanguage').value;

            if (!salary || !occupation || !dependents || !age || !preferredLanguage) {
                showError('Please fill in all fields');
                return;
            }

            // Store language preference
            userPreferredLanguage = preferredLanguage;

            showLoading(true);

            try {
                const response = await fetch('/api/calculate-risk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ salary, occupation, dependents, age })
                });

                const data = await response.json();

                if (data.success) {
                    userProfile = data.user_profile;
                    // Add language preference to user profile
                    userProfile.preferred_language = userPreferredLanguage;

                    document.getElementById('riskProfile').innerHTML = `
                        <h2>${data.risk_profile}</h2>
                        <p style="font-size: 24px; font-weight: bold;">Risk Score: ${data.risk_score}/100</p>
                    `;
                    showStep(2);

                    // Start conversation
                    await startConversation();
                } else {
                    showError(data.error);
                }
            } catch (error) {
                showError('Failed to calculate risk profile: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function startConversation() {
            try {
                showLoading(true);

                const response = await fetch('/api/conversation/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_profile: userProfile })
                });

                const data = await response.json();

                if (data.success) {
                    conversationStage = 'greeting';

                    // Display bot greeting
                    displayBotMessage(data.bot_message, data.audio);

                    // Add to conversation history
                    conversationHistory.push({
                        role: 'bot',
                        content: data.bot_message
                    });

                    // Enable microphone for user response
                    waitingForUser = true;
                    document.getElementById('recordingStatus').textContent = 'Ready to record';
                } else {
                    showError('Failed to start conversation');
                }
            } catch (error) {
                showError('Error starting conversation: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function displayBotMessage(message, audioData) {
            // Show bot message
            const botMessageSection = document.getElementById('botMessageSection');
            const botMessageText = document.getElementById('botMessageText');

            botMessageText.textContent = message;
            botMessageSection.style.display = 'block';

            // Play audio if available
            if (audioData) {
                botAudioPlayer = document.getElementById('botAudioPlayer');
                botAudioPlayer.src = audioData;

                botAudioPlayer.play().catch(error => {
                    console.log('Autoplay blocked:', error);
                });

                botAudioPlayer.onended = () => {
                    console.log('Bot audio finished playing');
                };
            }
        }

        function displayUserMessage(message) {
            const conversationContainer = document.getElementById('conversationContainer');

            const userMessageHTML = `
                <div class="user-message">
                    <div class="user-avatar">üë§</div>
                    <div class="user-message-content">
                        <p>${message}</p>
                    </div>
                </div>
            `;

            conversationContainer.innerHTML += userMessageHTML;
            conversationContainer.scrollTop = conversationContainer.scrollHeight;
        }

        function moveBotMessageToHistory() {
            const botMessageSection = document.getElementById('botMessageSection');
            const botMessageText = document.getElementById('botMessageText').textContent;
            const conversationContainer = document.getElementById('conversationContainer');

            if (botMessageText) {
                const botMessageHTML = `
                    <div class="bot-message">
                        <div class="bot-avatar">ü§ñ</div>
                        <div class="bot-message-content">
                            <p>${botMessageText}</p>
                        </div>
                    </div>
                `;

                conversationContainer.innerHTML += botMessageHTML;
                conversationContainer.scrollTop = conversationContainer.scrollHeight;
            }

            // Hide current bot message section
            botMessageSection.style.display = 'none';
        }

        function detectSilence(analyser, stream, button, status) {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const SILENCE_THRESHOLD = 25; // Adjust this value to change sensitivity (lower = more sensitive)
            const SILENCE_DURATION = 5000; // 5 seconds of silence

            function checkAudioLevel() {
                if (!isDetectingSilence) return;

                analyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((a, b) => a + b) / bufferLength;

                if (average < SILENCE_THRESHOLD) {
                    // Silence detected
                    if (silenceStart === null) {
                        silenceStart = Date.now();
                        status.textContent = 'Listening... (detecting silence)';
                    } else {
                        const silenceDuration = Date.now() - silenceStart;
                        const remaining = Math.ceil((SILENCE_DURATION - silenceDuration) / 1000);
                        if (remaining > 0) {
                            status.textContent = `Silence detected... stopping in ${remaining}s`;
                        }

                        if (silenceDuration >= SILENCE_DURATION) {
                            // 5 seconds of silence detected, stop recording
                            stopRecording(stream, button, status);
                            return;
                        }
                    }
                } else {
                    // Sound detected, reset silence timer
                    silenceStart = null;
                    status.textContent = 'Recording... (speak your goals)';
                }

                requestAnimationFrame(checkAudioLevel);
            }

            isDetectingSilence = true;
            checkAudioLevel();
        }

        function stopRecording(stream, button, status) {
            isDetectingSilence = false;
            silenceStart = null;

            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                button.classList.remove('recording');
                status.textContent = 'Transcribing...';
            }

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            stream.getTracks().forEach(track => track.stop());
        }

        async function toggleRecording() {
            const button = document.getElementById('recordButton');
            const status = document.getElementById('recordingStatus');

            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                    // Set up audio context for silence detection
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    const source = audioContext.createMediaStreamSource(stream);
                    source.connect(analyser);
                    analyser.fftSize = 2048;

                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        await transcribeAudio(audioBlob);
                    };

                    mediaRecorder.start();
                    button.classList.add('recording');
                    status.textContent = 'Recording... (speak your goals)';

                    // Start silence detection
                    detectSilence(analyser, stream, button, status);

                } catch (error) {
                    showError('Microphone access denied or not available');
                    isDetectingSilence = false;
                }
            }
        }

        async function transcribeAudio(audioBlob) {
            showLoading(true);

            try {
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);

                reader.onloadend = async () => {
                    const base64Audio = reader.result;

                    // Step 1: Transcribe audio
                    const transcribeResponse = await fetch('/api/transcribe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ audio: base64Audio })
                    });

                    const transcribeData = await transcribeResponse.json();

                    if (transcribeData.success) {
                        transcribedText = transcribeData.text;

                        // Move current bot message to history
                        moveBotMessageToHistory();

                        // Display user message
                        displayUserMessage(transcribedText);

                        // Add to conversation history
                        conversationHistory.push({
                            role: 'user',
                            content: transcribedText
                        });

                        document.getElementById('recordingStatus').textContent = 'Processing...';

                        // Step 2: Continue conversation
                        await continueConversation(transcribedText);
                    } else {
                        showError(transcribeData.error);
                        document.getElementById('recordingStatus').textContent = 'Transcription failed. Try again.';
                    }

                    showLoading(false);
                };
            } catch (error) {
                showError('Failed to transcribe audio: ' + error.message);
                showLoading(false);
            }
        }

        async function continueConversation(userText) {
            try {
                const response = await fetch('/api/conversation/continue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_text: userText,
                        user_profile: userProfile,
                        conversation_history: conversationHistory,
                        previous_allocation: currentAllocation
                    })
                });

                const data = await response.json();

                if (data.success) {
                    conversationStage = data.stage;

                    if (data.stage === 'questioning') {
                        // Bot has another question
                        displayBotMessage(data.bot_message, data.audio);

                        conversationHistory.push({
                            role: 'bot',
                            content: data.bot_message
                        });

                        document.getElementById('recordingStatus').textContent = 'Ready to record';
                        waitingForUser = true;

                    } else if (data.stage === 'allocation_generated') {
                        // Allocation is ready
                        currentAllocation = data.allocation;
                        detectedLanguage = data.detected_language;
                        displayAllocation(data.allocation);
                        showStep(3);
                    }
                } else {
                    showError(data.error || 'Failed to continue conversation');
                    document.getElementById('recordingStatus').textContent = 'Error. Try again.';
                }
            } catch (error) {
                showError('Error in conversation: ' + error.message);
                document.getElementById('recordingStatus').textContent = 'Error. Try again.';
            }
        }

        async function displayAllocation(allocation) {
            let html = '';

            if (allocation.description) {
                html += `<div class="allocation-card">
                    <h3 style="margin-bottom: 10px;">üìù Strategy</h3>
                    <p>${allocation.description}</p>
                </div>`;
            }

            html += '<div class="allocation-card"><h3 style="margin-bottom: 15px;">üíº Fund Allocation</h3>';

            allocation.allocation.forEach(fund => {
                const fundAmount = fund.investment_amount || 0;
                html += `
                    <div class="fund-item">
                        <div class="fund-header">
                            <div class="fund-name">${fund.fund_name}</div>
                            <div class="fund-percentage">
                                <div style="font-size: 18px; font-weight: bold; color: #667eea;">‚Çπ${fundAmount.toLocaleString('en-IN')}</div>
                                <div style="font-size: 12px; color: #999;">(${fund.percentage}%)</div>
                            </div>
                        </div>
                        <div class="fund-details">
                            <span>${fund.fund_category}</span>
                            <span>3Y CAGR: ${fund.cagr_3y}%</span>
                        </div>
                        <div style="font-size: 12px; color: #999; margin-top: 5px;">ISIN: ${fund.isin}</div>
                    </div>
                `;
            });

            html += '</div>';

            // Investment Calculations Display
            if (allocation.investment_calculations) {
                const calc = allocation.investment_calculations;
                const investType = allocation.investment_type;
                const sipFreq = allocation.sip_frequency;

                html += `<div class="allocation-card" style="background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);">
                    <h3 style="margin-bottom: 15px;">üí∞ Investment Projections</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Investment Type</div>
                            <div style="font-size: 18px; font-weight: bold; color: #667eea;">
                                ${investType}${sipFreq ? ` (${sipFreq})` : ''}
                            </div>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Period</div>
                            <div style="font-size: 18px; font-weight: bold; color: #667eea;">
                                ${calc.investment_period_years} years
                            </div>
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Total Invested</div>
                        <div style="font-size: 24px; font-weight: bold; color: #333;">
                            ‚Çπ${calc.total_invested.toLocaleString('en-IN')}
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Expected Corpus*</div>
                        <div style="font-size: 24px; font-weight: bold; color: #4caf50;">
                            ‚Çπ${calc.expected_corpus.toLocaleString('en-IN')}
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Expected Gains*</div>
                        <div style="font-size: 24px; font-weight: bold; color: #ff9800;">
                            ‚Çπ${calc.expected_gains.toLocaleString('en-IN')}
                        </div>
                    </div>
                    <p style="font-size: 11px; color: #666; margin-top: 10px; font-style: italic;">
                        *Projections based on historical ${allocation.blended_3y_cagr}% CAGR.
                        Past performance doesn't guarantee future returns.
                    </p>
                </div>`;
            }

            html += `<div class="blended-return">
                <strong>Historical Blended 3Y CAGR: ${allocation.blended_3y_cagr}%</strong>
                <p style="font-size: 12px; margin-top: 5px; opacity: 0.9;">*Past performance does not guarantee future returns</p>
            </div>`;

            document.getElementById('allocationDisplay').innerHTML = html;
            document.getElementById('modificationCount').textContent = `Modifications remaining: ${2 - modificationCount}`;

            // Generate and play audio explanation
            if (allocation.description) {
                await generateAndPlayAudio(allocation.description);
            }
        }

        async function generateAndPlayAudio(text) {
            const audioPlayerSection = document.getElementById('audioPlayerSection');
            const audioStatus = document.getElementById('audioStatus');

            try {
                // Show audio player section
                audioPlayerSection.style.display = 'block';
                audioStatus.textContent = 'Generating voice explanation...';

                const response = await fetch('/api/text-to-speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        language: userPreferredLanguage
                    })
                });

                const data = await response.json();

                if (data.success) {
                    audioPlayer = document.getElementById('audioPlayer');
                    currentAudioSrc = data.audio;
                    audioPlayer.src = currentAudioSrc;

                    // Auto-play the audio
                    audioStatus.textContent = 'Playing explanation...';
                    try {
                        await audioPlayer.play();

                        // Update status when audio ends
                        audioPlayer.onended = () => {
                            audioStatus.textContent = 'Click replay to hear again';
                        };

                        // Update status if there's an error
                        audioPlayer.onerror = () => {
                            audioStatus.textContent = 'Audio ready - click replay to listen';
                        };
                    } catch (playError) {
                        // Autoplay might be blocked by browser
                        audioStatus.textContent = 'Audio ready - click replay to listen';
                        console.log('Autoplay blocked, user can manually play:', playError);
                    }
                } else {
                    audioStatus.textContent = 'Could not generate audio';
                    showError('Failed to generate audio explanation');
                }
            } catch (error) {
                audioStatus.textContent = 'Audio generation failed';
                console.error('TTS error:', error);
            }
        }

        function toggleMute() {
            const muteButton = document.getElementById('muteButton');
            audioPlayer = document.getElementById('audioPlayer');

            if (!audioPlayer) return;

            isMuted = !isMuted;
            audioPlayer.muted = isMuted;

            if (isMuted) {
                muteButton.textContent = 'üîá';
                muteButton.classList.add('muted');
            } else {
                muteButton.textContent = 'üîä';
                muteButton.classList.remove('muted');
            }
        }

        function replayAudio() {
            audioPlayer = document.getElementById('audioPlayer');
            const audioStatus = document.getElementById('audioStatus');

            if (!audioPlayer || !currentAudioSrc) {
                showError('No audio available to replay');
                return;
            }

            audioStatus.textContent = 'Playing explanation...';
            audioPlayer.currentTime = 0;
            audioPlayer.play().catch(error => {
                audioStatus.textContent = 'Could not play audio';
                console.error('Replay error:', error);
            });
        }

        async function modifyAllocation() {
            if (modificationCount >= 2) {
                showError('Maximum modifications (2) reached. Please finalize or start a new session.');
                return;
            }
            modificationCount++;

            // Reset audio player
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer.src = '';
            }
            currentAudioSrc = null;
            isMuted = false;
            document.getElementById('audioPlayerSection').style.display = 'none';

            // Go back to conversation mode
            showStep(2);

            // Bot asks what to change (in preferred language)
            const botMessage = userPreferredLanguage === 'hindi'
                ? "‡§Ü‡§™ ‡§Ö‡§™‡§®‡•á ‡§®‡§ø‡§µ‡•á‡§∂ ‡§Æ‡•á‡§Ç ‡§ï‡•ç‡§Ø‡§æ ‡§¨‡§¶‡§≤‡§æ‡§µ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç? ‡§Ü‡§™ ‡§Ö‡§ß‡§ø‡§ï ‡§µ‡•É‡§¶‡•ç‡§ß‡§ø, ‡§Ö‡§ß‡§ø‡§ï ‡§∏‡•Å‡§∞‡§ï‡•ç‡§∑‡§æ, ‡§ó‡•ã‡§≤‡•ç‡§° ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§æ‡§Ø‡•ã‡§ú‡§®, ‡§Ø‡§æ ‡§´‡§Ç‡§° ‡§ï‡•á ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§¨‡§¶‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡§π ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§"
                : "What would you like to change in your allocation? You can ask for more growth, more safety, adjust gold, or change fund types.";

            // Create TTS for modification question
            try {
                const response = await fetch('/api/text-to-speech', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: botMessage,
                        language: userPreferredLanguage
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayBotMessage(botMessage, data.audio);
                    conversationHistory.push({
                        role: 'bot',
                        content: botMessage
                    });

                    document.getElementById('recordingStatus').textContent = 'Ready to record';
                    waitingForUser = true;
                }
            } catch (error) {
                console.error('Error generating modification question:', error);
                displayBotMessage(botMessage, null);
            }
        }

        function finalizeAllocation() {
            if (confirm('Are you sure you want to finalize this allocation?')) {
                alert('‚úÖ Allocation finalized! Thank you for using NiveshPe.');
                location.reload();
            }
        }
    </script>
</body>
</html>
